"use strict";
/**
 * Copyright 2015-2017 info@neomerx.com
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
class QueryBuilder {
    constructor(type) {
        this.enableEncodeUri();
        this.type = type;
    }
    onlyFields(...fields) {
        this.fields = fields;
        return this;
    }
    withFilters(...filters) {
        this.filters = filters;
        return this;
    }
    withSorts(...sorts) {
        this.sorts = sorts;
        return this;
    }
    withIncludes(...relationships) {
        this.includes = relationships;
        return this;
    }
    withPagination(offset, limit) {
        offset = Math.max(-1, Math.floor(offset));
        limit = Math.max(0, Math.floor(limit));
        if (offset >= 0 && limit > 0) {
            this.offset = offset;
            this.limit = limit;
        }
        else {
            this.offset = undefined;
            this.limit = undefined;
        }
        return this;
    }
    enableEncodeUri() {
        this.isEncodeUriEnabled = true;
        return this;
    }
    disableEncodeUri() {
        this.isEncodeUriEnabled = false;
        return this;
    }
    read(index, relationship) {
        const relationshipTail = relationship === undefined ? `/${index}` : `/${index}/${relationship}`;
        const result = `/${this.type}${relationshipTail}${this.buildParameters(false)}`;
        return this.isEncodeUriEnabled === true ? encodeURIComponent(result) : result;
    }
    index() {
        const result = `/${this.type}${this.buildParameters(true)}`;
        return this.isEncodeUriEnabled === true ? encodeURIComponent(result) : result;
    }
    /**
     * @internal
     */
    buildParameters(isIncludeNonFields) {
        let params = null;
        // add field params to get URL like '/articles?include=author&fields[articles]=title,body&fields[people]=name'
        // see http://jsonapi.org/format/#fetching-sparse-fieldsets
        if (this.fields !== undefined && this.fields.length > 0) {
            let fieldsResult = '';
            for (let field of this.fields) {
                const curResult = `fields[${field.type}]=${this.separateByComma(field.fields)}`;
                fieldsResult = fieldsResult.length === 0 ? curResult : `${fieldsResult}&${curResult}`;
            }
            if (fieldsResult.length > 0) {
                params = fieldsResult;
            }
        }
        // add filter parameters to get URL like 'filter[id][greater-than]=10&filter[id][less-than]=20&filter[title][like]=%Typ%'
        // note: the spec do not specify format for filters http://jsonapi.org/format/#fetching-filtering
        if (isIncludeNonFields === true && this.filters !== undefined && this.filters.length > 0) {
            let filtersResult = '';
            for (let filter of this.filters) {
                const params = filter.parameters;
                const curResult = params === undefined ?
                    `filter[${filter.field}][${filter.operation}]` :
                    `filter[${filter.field}][${filter.operation}]=${this.separateByComma(params)}`;
                filtersResult = filtersResult.length === 0 ? curResult : `${filtersResult}&${curResult}`;
            }
            if (filtersResult.length > 0) {
                params = params === null ? filtersResult : `${params}&${filtersResult}`;
            }
        }
        // add sorts to get URL like '/articles?sort=-created,title'
        // see http://jsonapi.org/format/#fetching-sorting
        if (isIncludeNonFields === true && this.sorts !== undefined && this.sorts.length > 0) {
            let sortsList = '';
            for (let sort of this.sorts) {
                const sortParam = `${sort.isAscending === true ? '' : '-'}${sort.field}`;
                sortsList = sortsList.length > 0 ? `${sortsList},${sortParam}` : sortParam;
            }
            const sortsResult = `sort=${sortsList}`;
            params = params === null ? sortsResult : `${params}&${sortsResult}`;
        }
        // add includes to get URL like '/articles/1?include=author,comments.author'
        // see http://jsonapi.org/format/#fetching-includes
        if (isIncludeNonFields === true && this.includes !== undefined && this.includes.length > 0) {
            const includesResult = `include=${this.separateByComma(this.includes)}`;
            params = params === null ? includesResult : `${params}&${includesResult}`;
        }
        // add pagination to get URL like '/articles?page[offset]=50&page[limit]=25'
        // note: the spec do not strictly define pagination parameters
        if (isIncludeNonFields === true && this.offset !== undefined && this.limit !== undefined) {
            const paginationResult = `page[offset]=${this.offset}&page[limit]=${this.limit}`;
            params = params === null ? paginationResult : `${params}&${paginationResult}`;
        }
        const result = params === null ? '' : `?${params}`;
        return result;
    }
    /**
     * @internal
     */
    separateByComma(values) {
        return typeof values === 'string' ? values : values.join(',');
    }
}
exports.QueryBuilder = QueryBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVlcnlCdWlsZGVyLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL25lb21lcngvUHJvamVjdHMvbGltb25jZWxsby9mcmFtZXdvcmsvY29tcG9uZW50cy9Kc29uQXBpQ2xpZW50L2Rpc3QvIiwic291cmNlcyI6WyJKc29uQXBpQ2xpZW50L1F1ZXJ5QnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7O0FBVUg7SUFzQ0ksWUFBWSxJQUFrQjtRQUMxQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUVNLFVBQVUsQ0FBQyxHQUFHLE1BQWlDO1FBQ2xELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLFdBQVcsQ0FBQyxHQUFHLE9BQW1DO1FBQ3JELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBRXZCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLFNBQVMsQ0FBQyxHQUFHLEtBQStCO1FBQy9DLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLFlBQVksQ0FBQyxHQUFHLGFBQWlDO1FBQ3BELElBQUksQ0FBQyxRQUFRLEdBQUcsYUFBYSxDQUFDO1FBRTlCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLGNBQWMsQ0FBQyxNQUFjLEVBQUUsS0FBYTtRQUMvQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDMUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENB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QUFnQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDakYsTUFBTSxHQUFHLE1BQU0sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sSUFBSSxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2xGLENBQUM7UUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxFQUFFLENBQUM7UUFFbkQsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxlQUFlLENBQUMsTUFBeUI7UUFDN0MsTUFBTSxDQUFDLE9BQU8sTUFBTSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBWSxNQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzlFLENBQUM7Q0FDSjtBQW5MRCxvQ0FtTEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDE1LTIwMTcgaW5mb0BuZW9tZXJ4LmNvbVxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEZpZWxkUGFyYW1ldGVySW50ZXJmYWNlIH0gZnJvbSAnLi4vQ29udHJhY3RzL0pzb25BcGlDbGllbnQvRmllbGRQYXJhbWV0ZXJJbnRlcmZhY2UnO1xuaW1wb3J0IHsgRmlsdGVyUGFyYW1ldGVySW50ZXJmYWNlIH0gZnJvbSAnLi4vQ29udHJhY3RzL0pzb25BcGlDbGllbnQvRmlsdGVyUGFyYW1ldGVySW50ZXJmYWNlJztcbmltcG9ydCB7IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB9IGZyb20gJy4uL0NvbnRyYWN0cy9Kc29uQXBpQ2xpZW50L1F1ZXJ5QnVpbGRlckludGVyZmFjZSc7XG5pbXBvcnQgeyBTb3J0UGFyYW1ldGVySW50ZXJmYWNlIH0gZnJvbSAnLi4vQ29udHJhY3RzL0pzb25BcGlDbGllbnQvU29ydFBhcmFtZXRlckludGVyZmFjZSc7XG5pbXBvcnQgeyBSZWxhdGlvbnNoaXBOYW1lIH0gZnJvbSAnLi4vQ29udHJhY3RzL0pzb25BcGkvUmVsYXRpb25zaGlwTmFtZSc7XG5pbXBvcnQgeyBSZXNvdXJjZUlkZW50aXR5IH0gZnJvbSAnLi4vQ29udHJhY3RzL0pzb25BcGkvUmVzb3VyY2VJZGVudGl0eSc7XG5pbXBvcnQgeyBSZXNvdXJjZVR5cGUgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaS9SZXNvdXJjZVR5cGUnO1xuXG5leHBvcnQgY2xhc3MgUXVlcnlCdWlsZGVyIGltcGxlbWVudHMgUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAvKipcbiAgICAgKiBAaW50ZXJuYWxcbiAgICAgKi9cbiAgICBwcml2YXRlIHR5cGU6IFJlc291cmNlVHlwZTtcblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgZmllbGRzOiBGaWVsZFBhcmFtZXRlckludGVyZmFjZVtdIHwgdW5kZWZpbmVkO1xuXG4gICAgLyoqXG4gICAgICogQGludGVybmFsXG4gICAgICovXG4gICAgcHJpdmF0ZSBmaWx0ZXJzOiBGaWx0ZXJQYXJhbWV0ZXJJbnRlcmZhY2VbXSB8IHVuZGVmaW5lZDtcblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgc29ydHM6IFNvcnRQYXJhbWV0ZXJJbnRlcmZhY2VbXSB8IHVuZGVmaW5lZDtcblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgaW5jbHVkZXM6IFJlbGF0aW9uc2hpcE5hbWVbXSB8IHVuZGVmaW5lZDtcblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgb2Zmc2V0OiBudW1iZXIgfCB1bmRlZmluZWQ7XG5cbiAgICAvKipcbiAgICAgKiBAaW50ZXJuYWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGxpbWl0OiBudW1iZXIgfCB1bmRlZmluZWQ7XG5cbiAgICBwcml2YXRlIGlzRW5jb2RlVXJpRW5hYmxlZDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKHR5cGU6IFJlc291cmNlVHlwZSkge1xuICAgICAgICB0aGlzLmVuYWJsZUVuY29kZVVyaSgpO1xuICAgICAgICB0aGlzLnR5cGUgPSB0eXBlO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbmx5RmllbGRzKC4uLmZpZWxkczogRmllbGRQYXJhbWV0ZXJJbnRlcmZhY2VbXSk6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIHRoaXMuZmllbGRzID0gZmllbGRzO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB3aXRoRmlsdGVycyguLi5maWx0ZXJzOiBGaWx0ZXJQYXJhbWV0ZXJJbnRlcmZhY2VbXSk6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIHRoaXMuZmlsdGVycyA9IGZpbHRlcnM7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHdpdGhTb3J0cyguLi5zb3J0czogU29ydFBhcmFtZXRlckludGVyZmFjZVtdKTogUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAgICAgdGhpcy5zb3J0cyA9IHNvcnRzO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB3aXRoSW5jbHVkZXMoLi4ucmVsYXRpb25zaGlwczogUmVsYXRpb25zaGlwTmFtZVtdKTogUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAgICAgdGhpcy5pbmNsdWRlcyA9IHJlbGF0aW9uc2hpcHM7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHdpdGhQYWdpbmF0aW9uKG9mZnNldDogbnVtYmVyLCBsaW1pdDogbnVtYmVyKTogUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAgICAgb2Zmc2V0ID0gTWF0aC5tYXgoLTEsIE1hdGguZmxvb3Iob2Zmc2V0KSk7XG4gICAgICAgIGxpbWl0ID0gTWF0aC5tYXgoMCwgTWF0aC5mbG9vcihsaW1pdCkpO1xuXG4gICAgICAgIGlmIChvZmZzZXQgPj0gMCAmJiBsaW1pdCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0O1xuICAgICAgICAgICAgdGhpcy5saW1pdCA9IGxpbWl0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5vZmZzZXQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLmxpbWl0ID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGVuYWJsZUVuY29kZVVyaSgpOiBRdWVyeUJ1aWxkZXJJbnRlcmZhY2Uge1xuICAgICAgICB0aGlzLmlzRW5jb2RlVXJpRW5hYmxlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc2FibGVFbmNvZGVVcmkoKTogUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAgICAgdGhpcy5pc0VuY29kZVVyaUVuYWJsZWQgPSBmYWxzZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVhZChpbmRleDogUmVzb3VyY2VJZGVudGl0eSwgcmVsYXRpb25zaGlwPzogUmVsYXRpb25zaGlwTmFtZSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHJlbGF0aW9uc2hpcFRhaWwgPSByZWxhdGlvbnNoaXAgPT09IHVuZGVmaW5lZCA/IGAvJHtpbmRleH1gIDogYC8ke2luZGV4fS8ke3JlbGF0aW9uc2hpcH1gO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBgLyR7dGhpcy50eXBlfSR7cmVsYXRpb25zaGlwVGFpbH0ke3RoaXMuYnVpbGRQYXJhbWV0ZXJzKGZhbHNlKX1gO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmlzRW5jb2RlVXJpRW5hYmxlZCA9PT0gdHJ1ZSA/IGVuY29kZVVSSUNvbXBvbmVudChyZXN1bHQpIDogcmVzdWx0O1xuICAgIH1cblxuICAgIHB1YmxpYyBpbmRleCgpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBgLyR7dGhpcy50eXBlfSR7dGhpcy5idWlsZFBhcmFtZXRlcnModHJ1ZSl9YDtcblxuICAgICAgICByZXR1cm4gdGhpcy5pc0VuY29kZVVyaUVuYWJsZWQgPT09IHRydWUgPyBlbmNvZGVVUklDb21wb25lbnQocmVzdWx0KSA6IHJlc3VsdDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaW50ZXJuYWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGJ1aWxkUGFyYW1ldGVycyhpc0luY2x1ZGVOb25GaWVsZHM6IGJvb2xlYW4pOiBzdHJpbmcge1xuICAgICAgICBsZXQgcGFyYW1zID0gbnVsbDtcblxuICAgICAgICAvLyBhZGQgZmllbGQgcGFyYW1zIHRvIGdldCBVUkwgbGlrZSAnL2FydGljbGVzP2luY2x1ZGU9YXV0aG9yJmZpZWxkc1thcnRpY2xlc109dGl0bGUsYm9keSZmaWVsZHNbcGVvcGxlXT1uYW1lJ1xuICAgICAgICAvLyBzZWUgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZmV0Y2hpbmctc3BhcnNlLWZpZWxkc2V0c1xuICAgICAgICBpZiAodGhpcy5maWVsZHMgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmZpZWxkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBsZXQgZmllbGRzUmVzdWx0ID0gJyc7XG4gICAgICAgICAgICBmb3IgKGxldCBmaWVsZCBvZiB0aGlzLmZpZWxkcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1clJlc3VsdCA9IGBmaWVsZHNbJHtmaWVsZC50eXBlfV09JHt0aGlzLnNlcGFyYXRlQnlDb21tYShmaWVsZC5maWVsZHMpfWA7XG4gICAgICAgICAgICAgICAgZmllbGRzUmVzdWx0ID0gZmllbGRzUmVzdWx0Lmxlbmd0aCA9PT0gMCA/IGN1clJlc3VsdCA6IGAke2ZpZWxkc1Jlc3VsdH0mJHtjdXJSZXN1bHR9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChmaWVsZHNSZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHBhcmFtcyA9IGZpZWxkc1Jlc3VsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGFkZCBmaWx0ZXIgcGFyYW1ldGVycyB0byBnZXQgVVJMIGxpa2UgJ2ZpbHRlcltpZF1bZ3JlYXRlci10aGFuXT0xMCZmaWx0ZXJbaWRdW2xlc3MtdGhhbl09MjAmZmlsdGVyW3RpdGxlXVtsaWtlXT0lVHlwJSdcbiAgICAgICAgLy8gbm90ZTogdGhlIHNwZWMgZG8gbm90IHNwZWNpZnkgZm9ybWF0IGZvciBmaWx0ZXJzIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2ZldGNoaW5nLWZpbHRlcmluZ1xuICAgICAgICBpZiAoaXNJbmNsdWRlTm9uRmllbGRzID09PSB0cnVlICYmIHRoaXMuZmlsdGVycyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuZmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBsZXQgZmlsdGVyc1Jlc3VsdCA9ICcnO1xuICAgICAgICAgICAgZm9yIChsZXQgZmlsdGVyIG9mIHRoaXMuZmlsdGVycykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IGZpbHRlci5wYXJhbWV0ZXJzO1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1clJlc3VsdCA9IHBhcmFtcyA9PT0gdW5kZWZpbmVkID9cbiAgICAgICAgICAgICAgICAgICAgYGZpbHRlclske2ZpbHRlci5maWVsZH1dWyR7ZmlsdGVyLm9wZXJhdGlvbn1dYCA6XG4gICAgICAgICAgICAgICAgICAgIGBmaWx0ZXJbJHtmaWx0ZXIuZmllbGR9XVske2ZpbHRlci5vcGVyYXRpb259XT0ke3RoaXMuc2VwYXJhdGVCeUNvbW1hKHBhcmFtcyl9YDtcbiAgICAgICAgICAgICAgICBmaWx0ZXJzUmVzdWx0ID0gZmlsdGVyc1Jlc3VsdC5sZW5ndGggPT09IDAgPyBjdXJSZXN1bHQgOiBgJHtmaWx0ZXJzUmVzdWx0fSYke2N1clJlc3VsdH1gO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGZpbHRlcnNSZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyA9PT0gbnVsbCA/IGZpbHRlcnNSZXN1bHQgOiBgJHtwYXJhbXN9JiR7ZmlsdGVyc1Jlc3VsdH1gO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWRkIHNvcnRzIHRvIGdldCBVUkwgbGlrZSAnL2FydGljbGVzP3NvcnQ9LWNyZWF0ZWQsdGl0bGUnXG4gICAgICAgIC8vIHNlZSBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNmZXRjaGluZy1zb3J0aW5nXG4gICAgICAgIGlmIChpc0luY2x1ZGVOb25GaWVsZHMgPT09IHRydWUgJiYgdGhpcy5zb3J0cyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuc29ydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbGV0IHNvcnRzTGlzdCA9ICcnO1xuICAgICAgICAgICAgZm9yIChsZXQgc29ydCBvZiB0aGlzLnNvcnRzKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc29ydFBhcmFtID0gYCR7c29ydC5pc0FzY2VuZGluZyA9PT0gdHJ1ZSA/ICcnIDogJy0nfSR7c29ydC5maWVsZH1gO1xuICAgICAgICAgICAgICAgIHNvcnRzTGlzdCA9IHNvcnRzTGlzdC5sZW5ndGggPiAwID8gYCR7c29ydHNMaXN0fSwke3NvcnRQYXJhbX1gIDogc29ydFBhcmFtO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgc29ydHNSZXN1bHQgPSBgc29ydD0ke3NvcnRzTGlzdH1gO1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zID09PSBudWxsID8gc29ydHNSZXN1bHQgOiBgJHtwYXJhbXN9JiR7c29ydHNSZXN1bHR9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGFkZCBpbmNsdWRlcyB0byBnZXQgVVJMIGxpa2UgJy9hcnRpY2xlcy8xP2luY2x1ZGU9YXV0aG9yLGNvbW1lbnRzLmF1dGhvcidcbiAgICAgICAgLy8gc2VlIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2ZldGNoaW5nLWluY2x1ZGVzXG4gICAgICAgIGlmIChpc0luY2x1ZGVOb25GaWVsZHMgPT09IHRydWUgJiYgdGhpcy5pbmNsdWRlcyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuaW5jbHVkZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgaW5jbHVkZXNSZXN1bHQgPSBgaW5jbHVkZT0ke3RoaXMuc2VwYXJhdGVCeUNvbW1hKHRoaXMuaW5jbHVkZXMpfWA7XG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMgPT09IG51bGwgPyBpbmNsdWRlc1Jlc3VsdCA6IGAke3BhcmFtc30mJHtpbmNsdWRlc1Jlc3VsdH1gO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWRkIHBhZ2luYXRpb24gdG8gZ2V0IFVSTCBsaWtlICcvYXJ0aWNsZXM/cGFnZVtvZmZzZXRdPTUwJnBhZ2VbbGltaXRdPTI1J1xuICAgICAgICAvLyBub3RlOiB0aGUgc3BlYyBkbyBub3Qgc3RyaWN0bHkgZGVmaW5lIHBhZ2luYXRpb24gcGFyYW1ldGVyc1xuICAgICAgICBpZiAoaXNJbmNsdWRlTm9uRmllbGRzID09PSB0cnVlICYmIHRoaXMub2Zmc2V0ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5saW1pdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCBwYWdpbmF0aW9uUmVzdWx0ID0gYHBhZ2Vbb2Zmc2V0XT0ke3RoaXMub2Zmc2V0fSZwYWdlW2xpbWl0XT0ke3RoaXMubGltaXR9YDtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyA9PT0gbnVsbCA/IHBhZ2luYXRpb25SZXN1bHQgOiBgJHtwYXJhbXN9JiR7cGFnaW5hdGlvblJlc3VsdH1gO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcGFyYW1zID09PSBudWxsID8gJycgOiBgPyR7cGFyYW1zfWA7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaW50ZXJuYWxcbiAgICAgKi9cbiAgICBwcml2YXRlIHNlcGFyYXRlQnlDb21tYSh2YWx1ZXM6IHN0cmluZyB8IHN0cmluZ1tdKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZXMgPT09ICdzdHJpbmcnID8gdmFsdWVzIDogKDxzdHJpbmdbXT52YWx1ZXMpLmpvaW4oJywnKTtcbiAgICB9XG59XG4iXX0=