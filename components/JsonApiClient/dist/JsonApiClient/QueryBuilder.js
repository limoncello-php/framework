"use strict";
/**
 * Copyright 2015-2017 info@neomerx.com
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
class QueryBuilder {
    constructor(type) {
        this.enableEncodeUri();
        this.type = type;
    }
    onlyFields(...fields) {
        this.fields = fields;
        return this;
    }
    withFilters(...filters) {
        this.filters = filters;
        return this;
    }
    withSorts(...sorts) {
        this.sorts = sorts;
        return this;
    }
    withIncludes(...relationships) {
        this.includes = relationships;
        return this;
    }
    withPagination(offset, limit) {
        offset = Math.max(-1, Math.floor(offset));
        limit = Math.max(0, Math.floor(limit));
        if (offset >= 0 && limit > 0) {
            this.offset = offset;
            this.limit = limit;
        }
        else {
            this.offset = undefined;
            this.limit = undefined;
        }
        return this;
    }
    enableEncodeUri() {
        this.isEncodeUriEnabled = true;
        return this;
    }
    disableEncodeUri() {
        this.isEncodeUriEnabled = false;
        return this;
    }
    read(index, relationship) {
        const relationshipTail = relationship === undefined ? `/${index}` : `/${index}/${relationship}`;
        const result = `/${this.type}${relationshipTail}${this.buildParameters(false)}`;
        return this.isEncodeUriEnabled === true ? encodeURI(result) : result;
    }
    index() {
        const result = `/${this.type}${this.buildParameters(true)}`;
        return this.isEncodeUriEnabled === true ? encodeURI(result) : result;
    }
    /**
     * @internal
     */
    buildParameters(isIncludeNonFields) {
        let params = null;
        // add field params to get URL like '/articles?include=author&fields[articles]=title,body&fields[people]=name'
        // see http://jsonapi.org/format/#fetching-sparse-fieldsets
        if (this.fields !== undefined && this.fields.length > 0) {
            let fieldsResult = '';
            for (let field of this.fields) {
                const curResult = `fields[${field.type}]=${this.separateByComma(field.fields)}`;
                fieldsResult = fieldsResult.length === 0 ? curResult : `${fieldsResult}&${curResult}`;
            }
            if (fieldsResult.length > 0) {
                params = fieldsResult;
            }
        }
        // add filter parameters to get URL like 'filter[id][greater-than]=10&filter[id][less-than]=20&filter[title][like]=%Typ%'
        // note: the spec do not specify format for filters http://jsonapi.org/format/#fetching-filtering
        if (isIncludeNonFields === true && this.filters !== undefined && this.filters.length > 0) {
            let filtersResult = '';
            for (let filter of this.filters) {
                const params = filter.parameters;
                const curResult = params === undefined ?
                    `filter[${filter.field}][${filter.operation}]` :
                    `filter[${filter.field}][${filter.operation}]=${this.separateByComma(params)}`;
                filtersResult = filtersResult.length === 0 ? curResult : `${filtersResult}&${curResult}`;
            }
            if (filtersResult.length > 0) {
                params = params === null ? filtersResult : `${params}&${filtersResult}`;
            }
        }
        // add sorts to get URL like '/articles?sort=-created,title'
        // see http://jsonapi.org/format/#fetching-sorting
        if (isIncludeNonFields === true && this.sorts !== undefined && this.sorts.length > 0) {
            let sortsList = '';
            for (let sort of this.sorts) {
                const sortParam = `${sort.isAscending === true ? '' : '-'}${sort.field}`;
                sortsList = sortsList.length > 0 ? `${sortsList},${sortParam}` : sortParam;
            }
            const sortsResult = `sort=${sortsList}`;
            params = params === null ? sortsResult : `${params}&${sortsResult}`;
        }
        // add includes to get URL like '/articles/1?include=author,comments.author'
        // see http://jsonapi.org/format/#fetching-includes
        if (isIncludeNonFields === true && this.includes !== undefined && this.includes.length > 0) {
            const includesResult = `include=${this.separateByComma(this.includes)}`;
            params = params === null ? includesResult : `${params}&${includesResult}`;
        }
        // add pagination to get URL like '/articles?page[offset]=50&page[limit]=25'
        // note: the spec do not strictly define pagination parameters
        if (isIncludeNonFields === true && this.offset !== undefined && this.limit !== undefined) {
            const paginationResult = `page[offset]=${this.offset}&page[limit]=${this.limit}`;
            params = params === null ? paginationResult : `${params}&${paginationResult}`;
        }
        const result = params === null ? '' : `?${params}`;
        return result;
    }
    /**
     * @internal
     */
    separateByComma(values) {
        return Array.isArray(values) === true ? values.join(',') : `${values}`;
    }
}
exports.QueryBuilder = QueryBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVlcnlCdWlsZGVyLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL25lb21lcngvUHJvamVjdHMvbGltb25jZWxsby9mcmFtZXdvcmsvY29tcG9uZW50cy9Kc29uQXBpQ2xpZW50L2Rpc3QvIiwic291cmNlcyI6WyJKc29uQXBpQ2xpZW50L1F1ZXJ5QnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7O0FBVUg7SUFzQ0ksWUFBWSxJQUFrQjtRQUMxQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUVNLFVBQVUsQ0FBQyxHQUFHLE1BQWlDO1FBQ2xELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLFdBQVcsQ0FBQyxHQUFHLE9BQW1DO1FBQ3JELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBRXZCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLFNBQVMsQ0FBQyxHQUFHLEtBQStCO1FBQy9DLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLFlBQVksQ0FBQyxHQUFHLGFBQWlDO1FBQ3BELElBQUksQ0FBQyxRQUFRLEdBQUcsYUFBYSxDQUFDO1FBRTlCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLGNBQWMsQ0FBQyxNQUFjLEVBQUUsS0FBYTtRQUMvQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDMUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENB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LElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNqRixNQUFNLEdBQUcsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxJQUFJLGdCQUFnQixFQUFFLENBQUM7UUFDbEYsQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUVuRCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7T0FFRztJQUNLLGVBQWUsQ0FBQyxNQUF5QjtRQUM3QyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFZLE1BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQVcsTUFBTSxFQUFFLENBQUM7SUFDL0YsQ0FBQztDQUNKO0FBbkxELG9DQW1MQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTUtMjAxNyBpbmZvQG5lb21lcnguY29tXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgRmllbGRQYXJhbWV0ZXJJbnRlcmZhY2UgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaUNsaWVudC9GaWVsZFBhcmFtZXRlckludGVyZmFjZSc7XG5pbXBvcnQgeyBGaWx0ZXJQYXJhbWV0ZXJJbnRlcmZhY2UgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaUNsaWVudC9GaWx0ZXJQYXJhbWV0ZXJJbnRlcmZhY2UnO1xuaW1wb3J0IHsgUXVlcnlCdWlsZGVySW50ZXJmYWNlIH0gZnJvbSAnLi4vQ29udHJhY3RzL0pzb25BcGlDbGllbnQvUXVlcnlCdWlsZGVySW50ZXJmYWNlJztcbmltcG9ydCB7IFNvcnRQYXJhbWV0ZXJJbnRlcmZhY2UgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaUNsaWVudC9Tb3J0UGFyYW1ldGVySW50ZXJmYWNlJztcbmltcG9ydCB7IFJlbGF0aW9uc2hpcE5hbWUgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaS9SZWxhdGlvbnNoaXBOYW1lJztcbmltcG9ydCB7IFJlc291cmNlSWRlbnRpdHkgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaS9SZXNvdXJjZUlkZW50aXR5JztcbmltcG9ydCB7IFJlc291cmNlVHlwZSB9IGZyb20gJy4uL0NvbnRyYWN0cy9Kc29uQXBpL1Jlc291cmNlVHlwZSc7XG5cbmV4cG9ydCBjbGFzcyBRdWVyeUJ1aWxkZXIgaW1wbGVtZW50cyBRdWVyeUJ1aWxkZXJJbnRlcmZhY2Uge1xuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgdHlwZTogUmVzb3VyY2VUeXBlO1xuXG4gICAgLyoqXG4gICAgICogQGludGVybmFsXG4gICAgICovXG4gICAgcHJpdmF0ZSBmaWVsZHM6IEZpZWxkUGFyYW1ldGVySW50ZXJmYWNlW10gfCB1bmRlZmluZWQ7XG5cbiAgICAvKipcbiAgICAgKiBAaW50ZXJuYWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGZpbHRlcnM6IEZpbHRlclBhcmFtZXRlckludGVyZmFjZVtdIHwgdW5kZWZpbmVkO1xuXG4gICAgLyoqXG4gICAgICogQGludGVybmFsXG4gICAgICovXG4gICAgcHJpdmF0ZSBzb3J0czogU29ydFBhcmFtZXRlckludGVyZmFjZVtdIHwgdW5kZWZpbmVkO1xuXG4gICAgLyoqXG4gICAgICogQGludGVybmFsXG4gICAgICovXG4gICAgcHJpdmF0ZSBpbmNsdWRlczogUmVsYXRpb25zaGlwTmFtZVtdIHwgdW5kZWZpbmVkO1xuXG4gICAgLyoqXG4gICAgICogQGludGVybmFsXG4gICAgICovXG4gICAgcHJpdmF0ZSBvZmZzZXQ6IG51bWJlciB8IHVuZGVmaW5lZDtcblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgbGltaXQ6IG51bWJlciB8IHVuZGVmaW5lZDtcblxuICAgIHByaXZhdGUgaXNFbmNvZGVVcmlFbmFibGVkOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IodHlwZTogUmVzb3VyY2VUeXBlKSB7XG4gICAgICAgIHRoaXMuZW5hYmxlRW5jb2RlVXJpKCk7XG4gICAgICAgIHRoaXMudHlwZSA9IHR5cGU7XG4gICAgfVxuXG4gICAgcHVibGljIG9ubHlGaWVsZHMoLi4uZmllbGRzOiBGaWVsZFBhcmFtZXRlckludGVyZmFjZVtdKTogUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAgICAgdGhpcy5maWVsZHMgPSBmaWVsZHM7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHdpdGhGaWx0ZXJzKC4uLmZpbHRlcnM6IEZpbHRlclBhcmFtZXRlckludGVyZmFjZVtdKTogUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAgICAgdGhpcy5maWx0ZXJzID0gZmlsdGVycztcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgd2l0aFNvcnRzKC4uLnNvcnRzOiBTb3J0UGFyYW1ldGVySW50ZXJmYWNlW10pOiBRdWVyeUJ1aWxkZXJJbnRlcmZhY2Uge1xuICAgICAgICB0aGlzLnNvcnRzID0gc29ydHM7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHdpdGhJbmNsdWRlcyguLi5yZWxhdGlvbnNoaXBzOiBSZWxhdGlvbnNoaXBOYW1lW10pOiBRdWVyeUJ1aWxkZXJJbnRlcmZhY2Uge1xuICAgICAgICB0aGlzLmluY2x1ZGVzID0gcmVsYXRpb25zaGlwcztcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgd2l0aFBhZ2luYXRpb24ob2Zmc2V0OiBudW1iZXIsIGxpbWl0OiBudW1iZXIpOiBRdWVyeUJ1aWxkZXJJbnRlcmZhY2Uge1xuICAgICAgICBvZmZzZXQgPSBNYXRoLm1heCgtMSwgTWF0aC5mbG9vcihvZmZzZXQpKTtcbiAgICAgICAgbGltaXQgPSBNYXRoLm1heCgwLCBNYXRoLmZsb29yKGxpbWl0KSk7XG5cbiAgICAgICAgaWYgKG9mZnNldCA+PSAwICYmIGxpbWl0ID4gMCkge1xuICAgICAgICAgICAgdGhpcy5vZmZzZXQgPSBvZmZzZXQ7XG4gICAgICAgICAgICB0aGlzLmxpbWl0ID0gbGltaXQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm9mZnNldCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHRoaXMubGltaXQgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZW5hYmxlRW5jb2RlVXJpKCk6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIHRoaXMuaXNFbmNvZGVVcmlFbmFibGVkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZGlzYWJsZUVuY29kZVVyaSgpOiBRdWVyeUJ1aWxkZXJJbnRlcmZhY2Uge1xuICAgICAgICB0aGlzLmlzRW5jb2RlVXJpRW5hYmxlZCA9IGZhbHNlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWFkKGluZGV4OiBSZXNvdXJjZUlkZW50aXR5LCByZWxhdGlvbnNoaXA/OiBSZWxhdGlvbnNoaXBOYW1lKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcmVsYXRpb25zaGlwVGFpbCA9IHJlbGF0aW9uc2hpcCA9PT0gdW5kZWZpbmVkID8gYC8ke2luZGV4fWAgOiBgLyR7aW5kZXh9LyR7cmVsYXRpb25zaGlwfWA7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGAvJHt0aGlzLnR5cGV9JHtyZWxhdGlvbnNoaXBUYWlsfSR7dGhpcy5idWlsZFBhcmFtZXRlcnMoZmFsc2UpfWA7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuaXNFbmNvZGVVcmlFbmFibGVkID09PSB0cnVlID8gZW5jb2RlVVJJKHJlc3VsdCkgOiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHVibGljIGluZGV4KCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGAvJHt0aGlzLnR5cGV9JHt0aGlzLmJ1aWxkUGFyYW1ldGVycyh0cnVlKX1gO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmlzRW5jb2RlVXJpRW5hYmxlZCA9PT0gdHJ1ZSA/IGVuY29kZVVSSShyZXN1bHQpIDogcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgYnVpbGRQYXJhbWV0ZXJzKGlzSW5jbHVkZU5vbkZpZWxkczogYm9vbGVhbik6IHN0cmluZyB7XG4gICAgICAgIGxldCBwYXJhbXMgPSBudWxsO1xuXG4gICAgICAgIC8vIGFkZCBmaWVsZCBwYXJhbXMgdG8gZ2V0IFVSTCBsaWtlICcvYXJ0aWNsZXM/aW5jbHVkZT1hdXRob3ImZmllbGRzW2FydGljbGVzXT10aXRsZSxib2R5JmZpZWxkc1twZW9wbGVdPW5hbWUnXG4gICAgICAgIC8vIHNlZSBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNmZXRjaGluZy1zcGFyc2UtZmllbGRzZXRzXG4gICAgICAgIGlmICh0aGlzLmZpZWxkcyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuZmllbGRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGxldCBmaWVsZHNSZXN1bHQgPSAnJztcbiAgICAgICAgICAgIGZvciAobGV0IGZpZWxkIG9mIHRoaXMuZmllbGRzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VyUmVzdWx0ID0gYGZpZWxkc1ske2ZpZWxkLnR5cGV9XT0ke3RoaXMuc2VwYXJhdGVCeUNvbW1hKGZpZWxkLmZpZWxkcyl9YDtcbiAgICAgICAgICAgICAgICBmaWVsZHNSZXN1bHQgPSBmaWVsZHNSZXN1bHQubGVuZ3RoID09PSAwID8gY3VyUmVzdWx0IDogYCR7ZmllbGRzUmVzdWx0fSYke2N1clJlc3VsdH1gO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGZpZWxkc1Jlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1zID0gZmllbGRzUmVzdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWRkIGZpbHRlciBwYXJhbWV0ZXJzIHRvIGdldCBVUkwgbGlrZSAnZmlsdGVyW2lkXVtncmVhdGVyLXRoYW5dPTEwJmZpbHRlcltpZF1bbGVzcy10aGFuXT0yMCZmaWx0ZXJbdGl0bGVdW2xpa2VdPSVUeXAlJ1xuICAgICAgICAvLyBub3RlOiB0aGUgc3BlYyBkbyBub3Qgc3BlY2lmeSBmb3JtYXQgZm9yIGZpbHRlcnMgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZmV0Y2hpbmctZmlsdGVyaW5nXG4gICAgICAgIGlmIChpc0luY2x1ZGVOb25GaWVsZHMgPT09IHRydWUgJiYgdGhpcy5maWx0ZXJzICE9PSB1bmRlZmluZWQgJiYgdGhpcy5maWx0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGxldCBmaWx0ZXJzUmVzdWx0ID0gJyc7XG4gICAgICAgICAgICBmb3IgKGxldCBmaWx0ZXIgb2YgdGhpcy5maWx0ZXJzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gZmlsdGVyLnBhcmFtZXRlcnM7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VyUmVzdWx0ID0gcGFyYW1zID09PSB1bmRlZmluZWQgP1xuICAgICAgICAgICAgICAgICAgICBgZmlsdGVyWyR7ZmlsdGVyLmZpZWxkfV1bJHtmaWx0ZXIub3BlcmF0aW9ufV1gIDpcbiAgICAgICAgICAgICAgICAgICAgYGZpbHRlclske2ZpbHRlci5maWVsZH1dWyR7ZmlsdGVyLm9wZXJhdGlvbn1dPSR7dGhpcy5zZXBhcmF0ZUJ5Q29tbWEocGFyYW1zKX1gO1xuICAgICAgICAgICAgICAgIGZpbHRlcnNSZXN1bHQgPSBmaWx0ZXJzUmVzdWx0Lmxlbmd0aCA9PT0gMCA/IGN1clJlc3VsdCA6IGAke2ZpbHRlcnNSZXN1bHR9JiR7Y3VyUmVzdWx0fWA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZmlsdGVyc1Jlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zID09PSBudWxsID8gZmlsdGVyc1Jlc3VsdCA6IGAke3BhcmFtc30mJHtmaWx0ZXJzUmVzdWx0fWA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhZGQgc29ydHMgdG8gZ2V0IFVSTCBsaWtlICcvYXJ0aWNsZXM/c29ydD0tY3JlYXRlZCx0aXRsZSdcbiAgICAgICAgLy8gc2VlIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2ZldGNoaW5nLXNvcnRpbmdcbiAgICAgICAgaWYgKGlzSW5jbHVkZU5vbkZpZWxkcyA9PT0gdHJ1ZSAmJiB0aGlzLnNvcnRzICE9PSB1bmRlZmluZWQgJiYgdGhpcy5zb3J0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBsZXQgc29ydHNMaXN0ID0gJyc7XG4gICAgICAgICAgICBmb3IgKGxldCBzb3J0IG9mIHRoaXMuc29ydHMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzb3J0UGFyYW0gPSBgJHtzb3J0LmlzQXNjZW5kaW5nID09PSB0cnVlID8gJycgOiAnLSd9JHtzb3J0LmZpZWxkfWA7XG4gICAgICAgICAgICAgICAgc29ydHNMaXN0ID0gc29ydHNMaXN0Lmxlbmd0aCA+IDAgPyBgJHtzb3J0c0xpc3R9LCR7c29ydFBhcmFtfWAgOiBzb3J0UGFyYW07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzb3J0c1Jlc3VsdCA9IGBzb3J0PSR7c29ydHNMaXN0fWA7XG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMgPT09IG51bGwgPyBzb3J0c1Jlc3VsdCA6IGAke3BhcmFtc30mJHtzb3J0c1Jlc3VsdH1gO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWRkIGluY2x1ZGVzIHRvIGdldCBVUkwgbGlrZSAnL2FydGljbGVzLzE/aW5jbHVkZT1hdXRob3IsY29tbWVudHMuYXV0aG9yJ1xuICAgICAgICAvLyBzZWUgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZmV0Y2hpbmctaW5jbHVkZXNcbiAgICAgICAgaWYgKGlzSW5jbHVkZU5vbkZpZWxkcyA9PT0gdHJ1ZSAmJiB0aGlzLmluY2x1ZGVzICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pbmNsdWRlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBpbmNsdWRlc1Jlc3VsdCA9IGBpbmNsdWRlPSR7dGhpcy5zZXBhcmF0ZUJ5Q29tbWEodGhpcy5pbmNsdWRlcyl9YDtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyA9PT0gbnVsbCA/IGluY2x1ZGVzUmVzdWx0IDogYCR7cGFyYW1zfSYke2luY2x1ZGVzUmVzdWx0fWA7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhZGQgcGFnaW5hdGlvbiB0byBnZXQgVVJMIGxpa2UgJy9hcnRpY2xlcz9wYWdlW29mZnNldF09NTAmcGFnZVtsaW1pdF09MjUnXG4gICAgICAgIC8vIG5vdGU6IHRoZSBzcGVjIGRvIG5vdCBzdHJpY3RseSBkZWZpbmUgcGFnaW5hdGlvbiBwYXJhbWV0ZXJzXG4gICAgICAgIGlmIChpc0luY2x1ZGVOb25GaWVsZHMgPT09IHRydWUgJiYgdGhpcy5vZmZzZXQgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmxpbWl0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2luYXRpb25SZXN1bHQgPSBgcGFnZVtvZmZzZXRdPSR7dGhpcy5vZmZzZXR9JnBhZ2VbbGltaXRdPSR7dGhpcy5saW1pdH1gO1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zID09PSBudWxsID8gcGFnaW5hdGlvblJlc3VsdCA6IGAke3BhcmFtc30mJHtwYWdpbmF0aW9uUmVzdWx0fWA7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSBwYXJhbXMgPT09IG51bGwgPyAnJyA6IGA/JHtwYXJhbXN9YDtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgc2VwYXJhdGVCeUNvbW1hKHZhbHVlczogc3RyaW5nIHwgc3RyaW5nW10pOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZXMpID09PSB0cnVlID8gKDxzdHJpbmdbXT52YWx1ZXMpLmpvaW4oJywnKSA6IGAkezxzdHJpbmc+dmFsdWVzfWA7XG4gICAgfVxufVxuIl19