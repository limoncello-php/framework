"use strict";
/**
 * Copyright 2015-2018 info@neomerx.com
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
class QueryBuilder {
    constructor(type) {
        this.useAndWithFilters = true;
        this.isEncodeUriEnabled = true;
        this.type = type;
    }
    onlyFields(...fields) {
        this.fields = fields;
        return this;
    }
    withFilters(...filters) {
        this.filters = filters;
        return this;
    }
    combineFiltersWithAnd() {
        this.useAndWithFilters = true;
        return this;
    }
    combineFiltersWithOr() {
        this.useAndWithFilters = false;
        return this;
    }
    withSorts(...sorts) {
        this.sorts = sorts;
        return this;
    }
    withIncludes(...relationships) {
        this.includes = relationships;
        return this;
    }
    withPagination(offset, limit) {
        offset = Math.max(-1, Math.floor(offset));
        limit = Math.max(0, Math.floor(limit));
        if (offset >= 0 && limit > 0) {
            this.offset = offset;
            this.limit = limit;
        }
        else {
            this.offset = undefined;
            this.limit = undefined;
        }
        return this;
    }
    enableEncodeUri() {
        this.isEncodeUriEnabled = true;
        return this;
    }
    disableEncodeUri() {
        this.isEncodeUriEnabled = false;
        return this;
    }
    isUriEncodingEnabled() {
        return this.isEncodeUriEnabled;
    }
    read(index, relationship) {
        const relationshipTail = relationship === undefined ? `/${index}` : `/${index}/${relationship}`;
        const result = `/${this.type}${relationshipTail}${this.buildParameters(false)}`;
        return this.isUriEncodingEnabled() === true ? encodeURI(result) : result;
    }
    index() {
        const result = `/${this.type}${this.buildParameters(true)}`;
        return this.isUriEncodingEnabled() === true ? encodeURI(result) : result;
    }
    /**
     * @internal
     */
    buildParameters(isIncludeNonFields) {
        let params = null;
        // add field params to get URL like '/articles?include=author&fields[articles]=title,body&fields[people]=name'
        // see http://jsonapi.org/format/#fetching-sparse-fieldsets
        if (this.fields !== undefined && this.fields.length > 0) {
            let fieldsResult = '';
            for (let field of this.fields) {
                const curResult = `fields[${field.type}]=${QueryBuilder.separateByComma(field.fields)}`;
                fieldsResult = fieldsResult.length === 0 ? curResult : `${fieldsResult}&${curResult}`;
            }
            params = fieldsResult;
        }
        // add filter parameters to get URL like 'filter[id][greater-than]=10&filter[id][less-than]=20&filter[title][like]=%Typ%'
        // filters could be joined with `AND` (default) / `OR` (e.g. filter[or][field][operation]=...&filter[or][...]...)
        // note: the spec do not specify format for filters http://jsonapi.org/format/#fetching-filtering
        if (isIncludeNonFields === true && this.filters !== undefined && this.filters.length > 0) {
            let filtersResult = '';
            const operationPrefix = this.useAndWithFilters === true ? '' : '[or]';
            for (let filter of this.filters) {
                const params = filter.parameters;
                const curResult = params === undefined ?
                    `filter${operationPrefix}[${filter.field}][${filter.operation}]` :
                    `filter${operationPrefix}[${filter.field}][${filter.operation}]=${QueryBuilder.separateByComma(params)}`;
                filtersResult = filtersResult.length === 0 ? curResult : `${filtersResult}&${curResult}`;
            }
            params = params === null ? filtersResult : `${params}&${filtersResult}`;
        }
        // add sorts to get URL like '/articles?sort=-created,title'
        // see http://jsonapi.org/format/#fetching-sorting
        if (isIncludeNonFields === true && this.sorts !== undefined && this.sorts.length > 0) {
            let sortsList = '';
            for (let sort of this.sorts) {
                const sortParam = `${sort.isAscending === true ? '' : '-'}${sort.field}`;
                sortsList = sortsList.length > 0 ? `${sortsList},${sortParam}` : sortParam;
            }
            const sortsResult = `sort=${sortsList}`;
            params = params === null ? sortsResult : `${params}&${sortsResult}`;
        }
        // add includes to get URL like '/articles/1?include=author,comments.author'
        // see http://jsonapi.org/format/#fetching-includes
        if (isIncludeNonFields === true && this.includes !== undefined && this.includes.length > 0) {
            const includesResult = `include=${QueryBuilder.separateByComma(this.includes)}`;
            params = params === null ? includesResult : `${params}&${includesResult}`;
        }
        // add pagination to get URL like '/articles?page[offset]=50&page[limit]=25'
        // note: the spec do not strictly define pagination parameters
        if (isIncludeNonFields === true && this.offset !== undefined && this.limit !== undefined) {
            const paginationResult = `page[offset]=${this.offset}&page[limit]=${this.limit}`;
            params = params === null ? paginationResult : `${params}&${paginationResult}`;
        }
        return params === null ? '' : `?${params}`;
    }
    /**
     * @internal
     */
    static separateByComma(values) {
        return Array.isArray(values) === true ? values.join(',') : `${values}`;
    }
}
exports.QueryBuilder = QueryBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVlcnlCdWlsZGVyLmpzIiwic291cmNlUm9vdCI6Ii4vZGlzdC8iLCJzb3VyY2VzIjpbIkpzb25BcGlDbGllbnQvUXVlcnlCdWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7R0FjRzs7QUFVSCxNQUFhLFlBQVk7SUEyQ3JCLFlBQVksSUFBa0I7UUFDMUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQztRQUM5QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFFTSxVQUFVLENBQUMsR0FBRyxNQUFpQztRQUNsRCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUVyQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRU0sV0FBVyxDQUFDLEdBQUcsT0FBbUM7UUFDckQsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFFdkIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLHFCQUFxQjtRQUN4QixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1FBRTlCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxvQkFBb0I7UUFDdkIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztRQUUvQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRU0sU0FBUyxDQUFDLEdBQUcsS0FBK0I7UUFDL0MsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFbkIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLFlBQVksQ0FBQyxHQUFHLGFBQWlDO1FBQ3BELElBQUksQ0FBQyxRQUFRLEdBQUcsYUFBYSxDQUFDO1FBRTlCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxjQUFjLENBQUMsTUFBYyxFQUFFLEtBQWE7UUFDL0MsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQzFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFdkMsSUFBSSxNQUFNLElBQUksQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUU7WUFDMUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7U0FDdEI7YUFBTTtZQUNILElBQUksQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDO1NBQzFCO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLGVBQWU7UUFDbEIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztRQUUvQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRU0sZ0JBQWdCO1FBQ25CLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUM7UUFFaEMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLG9CQUFvQjtRQUN2QixPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztJQUNuQyxDQUFDO0lBRU0sSUFBSSxDQUFDLEtBQXVCLEVBQUUsWUFBK0I7UUFDaEUsTUFBTSxnQkFBZ0IsR0FBRyxZQUFZLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNoRyxNQUFNLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBRWhGLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixFQUFFLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUM3RSxDQUFDO0lBRU0sS0FBSztRQUNSLE1BQU0sTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFFNUQsT0FBTyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQzdFLENBQUM7SUFFRDs7T0FFRztJQUNLLGVBQWUsQ0FBQyxrQkFBMkI7UUFDL0MsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBRWxCLDhHQUE4RztRQUM5RywyREFBMkQ7UUFDM0QsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDckQsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLEtBQUssSUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDM0IsTUFBTSxTQUFTLEdBQUcsVUFBVSxLQUFLLENBQUMsSUFBSSxLQUFLLFlBQVksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7Z0JBQ3hGLFlBQVksR0FBRyxZQUFZLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLFlBQVksSUFBSSxTQUFTLEVBQUUsQ0FBQzthQUN6RjtZQUNELE1BQU0sR0FBRyxZQUFZLENBQUM7U0FDekI7UUFFRCx5SEFBeUg7UUFDekgsaUhBQWlIO1FBQ2pILGlHQUFpRztRQUNqRyxJQUFJLGtCQUFrQixLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdEYsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQ3RFLEtBQUssSUFBSSxNQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDN0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztnQkFDakMsTUFBTSxTQUFTLEdBQUcsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDO29CQUNwQyxTQUFTLGVBQWUsSUFBSSxNQUFNLENBQUMsS0FBSyxLQUFLLE1BQU0sQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO29CQUNsRSxTQUFTLGVBQWUsSUFBSSxNQUFNLENBQUMsS0FBSyxLQUFLLE1BQU0sQ0FBQyxTQUFTLEtBQUssWUFBWSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO2dCQUM3RyxhQUFhLEdBQUcsYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxhQUFhLElBQUksU0FBUyxFQUFFLENBQUM7YUFDNUY7WUFDRCxNQUFNLEdBQUcsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sSUFBSSxhQUFhLEVBQUUsQ0FBQztTQUMzRTtRQUVELDREQUE0RDtRQUM1RCxrREFBa0Q7UUFDbEQsSUFBSSxrQkFBa0IsS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2xGLElBQUksU0FBUyxHQUFHLEVBQUUsQ0FBQztZQUNuQixLQUFLLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBQ3pCLE1BQU0sU0FBUyxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDekUsU0FBUyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLFNBQVMsSUFBSSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO2FBQzlFO1lBQ0QsTUFBTSxXQUFXLEdBQUcsUUFBUSxTQUFTLEVBQUUsQ0FBQztZQUN4QyxNQUFNLEdBQUcsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sSUFBSSxXQUFXLEVBQUUsQ0FBQztTQUN2RTtRQUVELDRFQUE0RTtRQUM1RSxtREFBbUQ7UUFDbkQsSUFBSSxrQkFBa0IsS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3hGLE1BQU0sY0FBYyxHQUFHLFdBQVcsWUFBWSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUNoRixNQUFNLEdBQUcsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sSUFBSSxjQUFjLEVBQUUsQ0FBQztTQUM3RTtRQUVELDRFQUE0RTtRQUM1RSw4REFBOEQ7UUFDOUQsSUFBSSxrQkFBa0IsS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDdEYsTUFBTSxnQkFBZ0IsR0FBRyxnQkFBZ0IsSUFBSSxDQUFDLE1BQU0sZ0JBQWdCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNqRixNQUFNLEdBQUcsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxJQUFJLGdCQUFnQixFQUFFLENBQUM7U0FDakY7UUFFRCxPQUFPLE1BQU0sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQztJQUMvQyxDQUFDO0lBRUQ7O09BRUc7SUFDSyxNQUFNLENBQUMsZUFBZSxDQUFDLE1BQXlCO1FBQ3BELE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFZLE1BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQVcsTUFBTSxFQUFFLENBQUM7SUFDL0YsQ0FBQztDQUNKO0FBck1ELG9DQXFNQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTUtMjAxOCBpbmZvQG5lb21lcnguY29tXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgRmllbGRQYXJhbWV0ZXJJbnRlcmZhY2UgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaUNsaWVudC9GaWVsZFBhcmFtZXRlckludGVyZmFjZSc7XG5pbXBvcnQgeyBGaWx0ZXJQYXJhbWV0ZXJJbnRlcmZhY2UgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaUNsaWVudC9GaWx0ZXJQYXJhbWV0ZXJJbnRlcmZhY2UnO1xuaW1wb3J0IHsgUXVlcnlCdWlsZGVySW50ZXJmYWNlIH0gZnJvbSAnLi4vQ29udHJhY3RzL0pzb25BcGlDbGllbnQvUXVlcnlCdWlsZGVySW50ZXJmYWNlJztcbmltcG9ydCB7IFNvcnRQYXJhbWV0ZXJJbnRlcmZhY2UgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaUNsaWVudC9Tb3J0UGFyYW1ldGVySW50ZXJmYWNlJztcbmltcG9ydCB7IFJlbGF0aW9uc2hpcE5hbWUgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaS9SZWxhdGlvbnNoaXBOYW1lJztcbmltcG9ydCB7IFJlc291cmNlSWRlbnRpdHkgfSBmcm9tICcuLi9Db250cmFjdHMvSnNvbkFwaS9SZXNvdXJjZUlkZW50aXR5JztcbmltcG9ydCB7IFJlc291cmNlVHlwZSB9IGZyb20gJy4uL0NvbnRyYWN0cy9Kc29uQXBpL1Jlc291cmNlVHlwZSc7XG5cbmV4cG9ydCBjbGFzcyBRdWVyeUJ1aWxkZXIgaW1wbGVtZW50cyBRdWVyeUJ1aWxkZXJJbnRlcmZhY2Uge1xuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgdHlwZTogUmVzb3VyY2VUeXBlO1xuXG4gICAgLyoqXG4gICAgICogQGludGVybmFsXG4gICAgICovXG4gICAgcHJpdmF0ZSBmaWVsZHM6IEZpZWxkUGFyYW1ldGVySW50ZXJmYWNlW10gfCB1bmRlZmluZWQ7XG5cbiAgICAvKipcbiAgICAgKiBAaW50ZXJuYWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGZpbHRlcnM6IEZpbHRlclBhcmFtZXRlckludGVyZmFjZVtdIHwgdW5kZWZpbmVkO1xuXG4gICAgLyoqXG4gICAgICogQGludGVybmFsXG4gICAgICovXG4gICAgcHJpdmF0ZSB1c2VBbmRXaXRoRmlsdGVyczogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgc29ydHM6IFNvcnRQYXJhbWV0ZXJJbnRlcmZhY2VbXSB8IHVuZGVmaW5lZDtcblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgaW5jbHVkZXM6IFJlbGF0aW9uc2hpcE5hbWVbXSB8IHVuZGVmaW5lZDtcblxuICAgIC8qKlxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIHByaXZhdGUgb2Zmc2V0OiBudW1iZXIgfCB1bmRlZmluZWQ7XG5cbiAgICAvKipcbiAgICAgKiBAaW50ZXJuYWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGxpbWl0OiBudW1iZXIgfCB1bmRlZmluZWQ7XG5cbiAgICBwcml2YXRlIGlzRW5jb2RlVXJpRW5hYmxlZDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKHR5cGU6IFJlc291cmNlVHlwZSkge1xuICAgICAgICB0aGlzLnVzZUFuZFdpdGhGaWx0ZXJzID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5pc0VuY29kZVVyaUVuYWJsZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLnR5cGUgPSB0eXBlO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbmx5RmllbGRzKC4uLmZpZWxkczogRmllbGRQYXJhbWV0ZXJJbnRlcmZhY2VbXSk6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIHRoaXMuZmllbGRzID0gZmllbGRzO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB3aXRoRmlsdGVycyguLi5maWx0ZXJzOiBGaWx0ZXJQYXJhbWV0ZXJJbnRlcmZhY2VbXSk6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIHRoaXMuZmlsdGVycyA9IGZpbHRlcnM7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbWJpbmVGaWx0ZXJzV2l0aEFuZCgpOiBRdWVyeUJ1aWxkZXJJbnRlcmZhY2Uge1xuICAgICAgICB0aGlzLnVzZUFuZFdpdGhGaWx0ZXJzID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tYmluZUZpbHRlcnNXaXRoT3IoKTogUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAgICAgdGhpcy51c2VBbmRXaXRoRmlsdGVycyA9IGZhbHNlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB3aXRoU29ydHMoLi4uc29ydHM6IFNvcnRQYXJhbWV0ZXJJbnRlcmZhY2VbXSk6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIHRoaXMuc29ydHMgPSBzb3J0cztcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgd2l0aEluY2x1ZGVzKC4uLnJlbGF0aW9uc2hpcHM6IFJlbGF0aW9uc2hpcE5hbWVbXSk6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIHRoaXMuaW5jbHVkZXMgPSByZWxhdGlvbnNoaXBzO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB3aXRoUGFnaW5hdGlvbihvZmZzZXQ6IG51bWJlciwgbGltaXQ6IG51bWJlcik6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIG9mZnNldCA9IE1hdGgubWF4KC0xLCBNYXRoLmZsb29yKG9mZnNldCkpO1xuICAgICAgICBsaW1pdCA9IE1hdGgubWF4KDAsIE1hdGguZmxvb3IobGltaXQpKTtcblxuICAgICAgICBpZiAob2Zmc2V0ID49IDAgJiYgbGltaXQgPiAwKSB7XG4gICAgICAgICAgICB0aGlzLm9mZnNldCA9IG9mZnNldDtcbiAgICAgICAgICAgIHRoaXMubGltaXQgPSBsaW1pdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMub2Zmc2V0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgdGhpcy5saW1pdCA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBlbmFibGVFbmNvZGVVcmkoKTogUXVlcnlCdWlsZGVySW50ZXJmYWNlIHtcbiAgICAgICAgdGhpcy5pc0VuY29kZVVyaUVuYWJsZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBkaXNhYmxlRW5jb2RlVXJpKCk6IFF1ZXJ5QnVpbGRlckludGVyZmFjZSB7XG4gICAgICAgIHRoaXMuaXNFbmNvZGVVcmlFbmFibGVkID0gZmFsc2U7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGlzVXJpRW5jb2RpbmdFbmFibGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pc0VuY29kZVVyaUVuYWJsZWQ7XG4gICAgfVxuXG4gICAgcHVibGljIHJlYWQoaW5kZXg6IFJlc291cmNlSWRlbnRpdHksIHJlbGF0aW9uc2hpcD86IFJlbGF0aW9uc2hpcE5hbWUpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCByZWxhdGlvbnNoaXBUYWlsID0gcmVsYXRpb25zaGlwID09PSB1bmRlZmluZWQgPyBgLyR7aW5kZXh9YCA6IGAvJHtpbmRleH0vJHtyZWxhdGlvbnNoaXB9YDtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYC8ke3RoaXMudHlwZX0ke3JlbGF0aW9uc2hpcFRhaWx9JHt0aGlzLmJ1aWxkUGFyYW1ldGVycyhmYWxzZSl9YDtcblxuICAgICAgICByZXR1cm4gdGhpcy5pc1VyaUVuY29kaW5nRW5hYmxlZCgpID09PSB0cnVlID8gZW5jb2RlVVJJKHJlc3VsdCkgOiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHVibGljIGluZGV4KCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGAvJHt0aGlzLnR5cGV9JHt0aGlzLmJ1aWxkUGFyYW1ldGVycyh0cnVlKX1gO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmlzVXJpRW5jb2RpbmdFbmFibGVkKCkgPT09IHRydWUgPyBlbmNvZGVVUkkocmVzdWx0KSA6IHJlc3VsdDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaW50ZXJuYWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGJ1aWxkUGFyYW1ldGVycyhpc0luY2x1ZGVOb25GaWVsZHM6IGJvb2xlYW4pOiBzdHJpbmcge1xuICAgICAgICBsZXQgcGFyYW1zID0gbnVsbDtcblxuICAgICAgICAvLyBhZGQgZmllbGQgcGFyYW1zIHRvIGdldCBVUkwgbGlrZSAnL2FydGljbGVzP2luY2x1ZGU9YXV0aG9yJmZpZWxkc1thcnRpY2xlc109dGl0bGUsYm9keSZmaWVsZHNbcGVvcGxlXT1uYW1lJ1xuICAgICAgICAvLyBzZWUgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZmV0Y2hpbmctc3BhcnNlLWZpZWxkc2V0c1xuICAgICAgICBpZiAodGhpcy5maWVsZHMgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmZpZWxkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBsZXQgZmllbGRzUmVzdWx0ID0gJyc7XG4gICAgICAgICAgICBmb3IgKGxldCBmaWVsZCBvZiB0aGlzLmZpZWxkcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1clJlc3VsdCA9IGBmaWVsZHNbJHtmaWVsZC50eXBlfV09JHtRdWVyeUJ1aWxkZXIuc2VwYXJhdGVCeUNvbW1hKGZpZWxkLmZpZWxkcyl9YDtcbiAgICAgICAgICAgICAgICBmaWVsZHNSZXN1bHQgPSBmaWVsZHNSZXN1bHQubGVuZ3RoID09PSAwID8gY3VyUmVzdWx0IDogYCR7ZmllbGRzUmVzdWx0fSYke2N1clJlc3VsdH1gO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFyYW1zID0gZmllbGRzUmVzdWx0O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWRkIGZpbHRlciBwYXJhbWV0ZXJzIHRvIGdldCBVUkwgbGlrZSAnZmlsdGVyW2lkXVtncmVhdGVyLXRoYW5dPTEwJmZpbHRlcltpZF1bbGVzcy10aGFuXT0yMCZmaWx0ZXJbdGl0bGVdW2xpa2VdPSVUeXAlJ1xuICAgICAgICAvLyBmaWx0ZXJzIGNvdWxkIGJlIGpvaW5lZCB3aXRoIGBBTkRgIChkZWZhdWx0KSAvIGBPUmAgKGUuZy4gZmlsdGVyW29yXVtmaWVsZF1bb3BlcmF0aW9uXT0uLi4mZmlsdGVyW29yXVsuLi5dLi4uKVxuICAgICAgICAvLyBub3RlOiB0aGUgc3BlYyBkbyBub3Qgc3BlY2lmeSBmb3JtYXQgZm9yIGZpbHRlcnMgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZmV0Y2hpbmctZmlsdGVyaW5nXG4gICAgICAgIGlmIChpc0luY2x1ZGVOb25GaWVsZHMgPT09IHRydWUgJiYgdGhpcy5maWx0ZXJzICE9PSB1bmRlZmluZWQgJiYgdGhpcy5maWx0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGxldCBmaWx0ZXJzUmVzdWx0ID0gJyc7XG4gICAgICAgICAgICBjb25zdCBvcGVyYXRpb25QcmVmaXggPSB0aGlzLnVzZUFuZFdpdGhGaWx0ZXJzID09PSB0cnVlID8gJycgOiAnW29yXSc7XG4gICAgICAgICAgICBmb3IgKGxldCBmaWx0ZXIgb2YgdGhpcy5maWx0ZXJzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gZmlsdGVyLnBhcmFtZXRlcnM7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VyUmVzdWx0ID0gcGFyYW1zID09PSB1bmRlZmluZWQgP1xuICAgICAgICAgICAgICAgICAgICBgZmlsdGVyJHtvcGVyYXRpb25QcmVmaXh9WyR7ZmlsdGVyLmZpZWxkfV1bJHtmaWx0ZXIub3BlcmF0aW9ufV1gIDpcbiAgICAgICAgICAgICAgICAgICAgYGZpbHRlciR7b3BlcmF0aW9uUHJlZml4fVske2ZpbHRlci5maWVsZH1dWyR7ZmlsdGVyLm9wZXJhdGlvbn1dPSR7UXVlcnlCdWlsZGVyLnNlcGFyYXRlQnlDb21tYShwYXJhbXMpfWA7XG4gICAgICAgICAgICAgICAgZmlsdGVyc1Jlc3VsdCA9IGZpbHRlcnNSZXN1bHQubGVuZ3RoID09PSAwID8gY3VyUmVzdWx0IDogYCR7ZmlsdGVyc1Jlc3VsdH0mJHtjdXJSZXN1bHR9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyA9PT0gbnVsbCA/IGZpbHRlcnNSZXN1bHQgOiBgJHtwYXJhbXN9JiR7ZmlsdGVyc1Jlc3VsdH1gO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWRkIHNvcnRzIHRvIGdldCBVUkwgbGlrZSAnL2FydGljbGVzP3NvcnQ9LWNyZWF0ZWQsdGl0bGUnXG4gICAgICAgIC8vIHNlZSBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNmZXRjaGluZy1zb3J0aW5nXG4gICAgICAgIGlmIChpc0luY2x1ZGVOb25GaWVsZHMgPT09IHRydWUgJiYgdGhpcy5zb3J0cyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuc29ydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbGV0IHNvcnRzTGlzdCA9ICcnO1xuICAgICAgICAgICAgZm9yIChsZXQgc29ydCBvZiB0aGlzLnNvcnRzKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc29ydFBhcmFtID0gYCR7c29ydC5pc0FzY2VuZGluZyA9PT0gdHJ1ZSA/ICcnIDogJy0nfSR7c29ydC5maWVsZH1gO1xuICAgICAgICAgICAgICAgIHNvcnRzTGlzdCA9IHNvcnRzTGlzdC5sZW5ndGggPiAwID8gYCR7c29ydHNMaXN0fSwke3NvcnRQYXJhbX1gIDogc29ydFBhcmFtO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgc29ydHNSZXN1bHQgPSBgc29ydD0ke3NvcnRzTGlzdH1gO1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zID09PSBudWxsID8gc29ydHNSZXN1bHQgOiBgJHtwYXJhbXN9JiR7c29ydHNSZXN1bHR9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGFkZCBpbmNsdWRlcyB0byBnZXQgVVJMIGxpa2UgJy9hcnRpY2xlcy8xP2luY2x1ZGU9YXV0aG9yLGNvbW1lbnRzLmF1dGhvcidcbiAgICAgICAgLy8gc2VlIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2ZldGNoaW5nLWluY2x1ZGVzXG4gICAgICAgIGlmIChpc0luY2x1ZGVOb25GaWVsZHMgPT09IHRydWUgJiYgdGhpcy5pbmNsdWRlcyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuaW5jbHVkZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgaW5jbHVkZXNSZXN1bHQgPSBgaW5jbHVkZT0ke1F1ZXJ5QnVpbGRlci5zZXBhcmF0ZUJ5Q29tbWEodGhpcy5pbmNsdWRlcyl9YDtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyA9PT0gbnVsbCA/IGluY2x1ZGVzUmVzdWx0IDogYCR7cGFyYW1zfSYke2luY2x1ZGVzUmVzdWx0fWA7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhZGQgcGFnaW5hdGlvbiB0byBnZXQgVVJMIGxpa2UgJy9hcnRpY2xlcz9wYWdlW29mZnNldF09NTAmcGFnZVtsaW1pdF09MjUnXG4gICAgICAgIC8vIG5vdGU6IHRoZSBzcGVjIGRvIG5vdCBzdHJpY3RseSBkZWZpbmUgcGFnaW5hdGlvbiBwYXJhbWV0ZXJzXG4gICAgICAgIGlmIChpc0luY2x1ZGVOb25GaWVsZHMgPT09IHRydWUgJiYgdGhpcy5vZmZzZXQgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmxpbWl0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2luYXRpb25SZXN1bHQgPSBgcGFnZVtvZmZzZXRdPSR7dGhpcy5vZmZzZXR9JnBhZ2VbbGltaXRdPSR7dGhpcy5saW1pdH1gO1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zID09PSBudWxsID8gcGFnaW5hdGlvblJlc3VsdCA6IGAke3BhcmFtc30mJHtwYWdpbmF0aW9uUmVzdWx0fWA7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcGFyYW1zID09PSBudWxsID8gJycgOiBgPyR7cGFyYW1zfWA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGludGVybmFsXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgc2VwYXJhdGVCeUNvbW1hKHZhbHVlczogc3RyaW5nIHwgc3RyaW5nW10pOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZXMpID09PSB0cnVlID8gKDxzdHJpbmdbXT52YWx1ZXMpLmpvaW4oJywnKSA6IGAkezxzdHJpbmc+dmFsdWVzfWA7XG4gICAgfVxufVxuIl19